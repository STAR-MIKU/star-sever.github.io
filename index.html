<!DOCTYPE html>
<html lang="zh-cn">

<head>
    <meta charset="UTF-8">
    <title>MuseFlutter</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- 引入CSS -->
    <link rel="stylesheet" href="./serve/css/reset.css">
    <link rel="stylesheet" href="./serve/css/index.css">
    <link rel="stylesheet" href="./serve/css/window.css">
    <link rel="icon" href="./serve/files/logo/logo.png" type="image/png">
    <script src="search-engine.js"></script>
    <!-- 引入桌宠功能 -->
    <script src="./serve/js/pet.js"></script>
    <!-- 引入Three.js库 -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
   
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/animation/CCDIKSolver.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/libs/ammo.wasm.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/controls/OrbitControls.js"></script>
</head>

<body>
    <!-- 搜索框区域 -->
    <style>
        /* 统一液态玻璃效果（搜索框与任务栏） */
        
        /* 自定义选中文本样式 */
        ::selection {
            background-color: rgba(102, 175, 233, 0.6);
            color: #fff;
        }
        
        ::-moz-selection {
            background-color: rgba(102, 175, 233, 0.6);
            color: #fff;
        }
        
        .glass-effect {
            background: rgba(255, 255, 255, 0.12);
            backdrop-filter: blur(12px) saturate(180%);
            -webkit-backdrop-filter: blur(12px) saturate(180%);
            border: 1px solid rgba(255, 255, 255, 0.20);
            box-shadow: 0 4px 24px 0 rgba(31, 38, 135, 0.12);
            border-radius: 16px;
            font-family: 'Chillax', sans-serif;
            position: relative;
            z-index: 1;
        }

        #search-container {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%) scale(0.8);
            opacity: 0;
            z-index: 10000;
            width: 500px;
            max-width: 90vw;
            border-radius: 16px;
            padding: 2px;
            display: flex;
            flex-direction: column;
            align-items: center;
            box-shadow: 0 4px 24px 0 rgba(31, 38, 135, 0.12);
            background: rgba(255, 255, 255, 0.12);
            border: 1px solid rgba(255, 255, 255, 0.20);
            font-family: 'Chillax', sans-serif;
            transition: all 0.6s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }

        #search-container.show {
            transform: translate(-50%, -50%) scale(1);
            opacity: 1;
        }

        #search-container .search-row {
            width: 100%;
            display: flex;
            align-items: center;
            gap: 0;
            font-family: inherit;
            position: relative;
        }

        /* 搜索标签样式 */
        .search-label {
            position: absolute;
            left: 15px;
            top: -10px;
            background: rgba(255, 255, 255, 0.12);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            padding: 2px 10px;
            border-radius: 12px;
            font-size: 12px;
            color: #333;
            font-weight: 500;
            border: 1px solid rgba(255, 255, 255, 0.20);
        }

        /* 搜索图标区域 */
        .search-icon-container {
            padding: 0 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            border-radius: 12px;
        }

        .search-icon {
            width: 24px;
            height: 24px;
            opacity: 0.8;
            transition: opacity 0.2s ease;
            fill: white;
        }

        .search-text {
            color: white;
            margin-left: 12px;
            font-size: 14px;
            white-space: nowrap;
        }

        .search-icon-container:hover .search-icon {
            opacity: 1;
        }

        /* 搜索引擎下拉菜单样式 */
        .engine-dropdown {
            position: absolute;
            top: 100%;
            left: -20px;
            margin-top: 6px;
            min-width: 150px;
            border-radius: 15px;
            overflow: hidden;
            display: none;
            z-index: 10002;
            transition: all 0.3s ease;
            transform-origin: top left;
            transform: scale(0.9) translateY(10px);
            opacity: 0;
            background: rgba(255, 255, 255, 0.12);
            backdrop-filter: blur(12px) saturate(180%);
            -webkit-backdrop-filter: blur(12px) saturate(180%);
        }

        .engine-dropdown.show {
            display: block;
            transform: scale(1) translateY(0);
            opacity: 1;
        }

        /* 分隔线 */
        .search-divider {
            width: 1px;
            height: 24px;
            background-color: #e0e0e0;
            margin: 0 8px;
        }

        /* 搜索输入框 */
        #search-input {
            flex: 1;
            height: 50px;
            border: none;
            padding: 0px 0px 0px 0px;
            font-size: 14px;
            outline: none;
            background: transparent;
            color: rgb(255, 255, 255);
            font-family: 'Chillax', sans-serif;
            font-weight: 900;
            white-space: nowrap;
        }

        #search-input::placeholder {
            color: rgba(255, 255, 255, 0.4);
        }

        /* 搜索按钮 */
        #search-btn {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: none;
            border: none;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
            margin-right: 5px;
            font-family: inherit;
        }

        #search-btn svg {
            width: 24px;
            height: 24px;
            fill: #00c853;
        }

        /* 搜索建议和历史记录 - 统一液态玻璃效果 */
        #search-suggestions {
            width: 96%;
            border-radius: 10px;
            margin-bottom: 10px;
            margin-top: -2px;
            display: none;
            position: absolute;
            top: 100%;
            left: 0;
            z-index: 10001;
            border-top: none;
            overflow: hidden;
            max-height: 320px;
            font-size: 15px;
            color: #333;
            background: rgba(255, 255, 255, 0.12);
            border: 1px solid rgba(255, 255, 255, 0.20);
            box-shadow: 0 4px 24px 0 rgba(31, 38, 135, 0.12);
            transform: translateZ(0) scale(0.92) translateY(12px);
            will-change: transform;
            -webkit-transform: translateZ(0) scale(0.92) translateY(12px);
            z-index: 10001;
            position: relative;
            overflow: hidden;
        }

        #search-suggestions::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: inherit;
            filter: blur(20px);
            -webkit-filter: blur(20px);
            z-index: -1;
            margin: -10px;
            opacity: 0.7;
        }

        #search-suggestions {
            opacity: 0;
            transition:
                opacity 0.3s ease,
                transform 0.3s ease;
            will-change: opacity, transform;
            pointer-events: auto;
        }

        #search-suggestions.show {
            opacity: 1;
            transform: scale(1) translateY(0);
            pointer-events: auto;
        }

        /* 搜索建议项和历史记录项动画 */
        .suggestion-item,
        .history-item {
            transform: scale(0.95);
            opacity: 0;
            transition: all 0.2s ease;
        }

        .suggestion-item.show,
        .history-item.show {
            transform: scale(1);
            opacity: 1;
        }

        /* 搜索引擎图标容器 */
        .engine-icons {
            float: right;
            margin-left: 10px;
        }

        /* 搜索引擎图标样式 */
        .engine-icon {
            width: 16px;
            height: 16px;
            margin-left: 4px;
            cursor: pointer;
            opacity: 0.7;
            transition: opacity 0.2s ease, transform 0.1s ease;
        }

        .engine-icon:hover {
            opacity: 1;
            transform: scale(1.1);
        }

        .engine-icon.active {
            opacity: 1;
            border: 1px solid #1677ff;
            border-radius: 2px;
        }

        /* 历史记录搜索引擎选择器样式 */
        .history-engine-selector {
            margin-left: 10px;
            padding: 3px 8px;
            background-color: rgba(255, 255, 255, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.3);
            border-radius: 4px;
            color: #fff;
            font-size: 12px;
            outline: none;
            cursor: pointer;
            transition: all 0.3s ease;
        }



        /* 统一的建议项和历史记录项样式 */
        .suggestion-item,
        .history-item {
            padding: 12px 20px;
            cursor: pointer;
            border-radius: 12px;
            margin: 4px 8px;
            position: relative;
            background: rgba(255, 255, 255, 0.12);
            z-index: 1;
        }

        .suggestion-item::before,
        .history-item::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: inherit;
            border-radius: inherit;
            filter: blur(20px);
            -webkit-filter: blur(20px);
            z-index: -1;
            margin: -5px;
            opacity: 0.7;
        }

        .suggestion-item,
        .history-item {
            transition: background 0.2s ease, box-shadow 0.2s ease;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            position: relative;
            color: #333;
            font-family: inherit;
            font-size: 15px;
            letter-spacing: 0.5px;
        }

        .suggestion-item:hover,
        .history-item:hover {
            background: rgba(255, 255, 255, 0.35);
            box-shadow: 0 4px 16px 0 rgba(31, 38, 135, 0.1);
        }

        /* 统一的建议标题和历史记录标题样式 */
        .suggestion-title,
        .history-title {
            padding: 0px 4px 4px 4px;
            font-weight: bold;
            color: #333;
            font-size: 13px;

            border-radius: 12px;
            margin: 8px 8px 2px 8px;
            letter-spacing: 1px;
            font-family: inherit;
        }

        .windows11-item.disabled {
            opacity: 0.5;
            pointer-events: none;
        }
    </style>
    <div id="search-container" class="glass-effect">
        <div class="search-row">
            <!-- 搜索图标区域 -->
            <div class="search-icon-container" id="searchEngineSelector">
                <svg class="search-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
                    <path
                        d="M18.031 16.617l4.283 4.282-1.415 1.415-4.282-4.283A8.96 8.96 0 0 1 11 20c-4.968 0-9-4.032-9-9s4.032-9 9-9 9 4.032 9 9a8.96 8.96 0 0 1-1.969 5.617zm-2.006-.742A6.977 6.977 0 0 0 18 11c0-3.868-3.133-7-7-7-3.868 0-7 3.132-7 7 0 3.867 3.132 7 7 7a6.977 6.977 0 0 0 4.875-1.975l.15-.15z">
                    </path>
                </svg>

            </div>
            <input id="search-input" type="text" autocomplete="off" placeholder="聚焦搜索" />
        </div>
        <div id="search-suggestions" class="glass-effect"></div>
    </div>
    <script>
        // 搜索记录
        let searchHistory = JSON.parse(localStorage.getItem('searchHistory') || '[]');
        // 当前搜索引擎，优先从localStorage读取，默认为百度
        let currentSearchEngine = localStorage.getItem('currentSearchEngine') || 'baidu';

        // 获取真实搜索建议（百度）
        function getBaiduSuggestions(keyword, callback) {
            if (!keyword) return callback([]);
            const cbName = 'baidu_sug_' + Math.random().toString(36).slice(2);
            window[cbName] = function (data) {
                let result = [];
                if (data && data.s) result = data.s;
                callback(result);
                setTimeout(() => { delete window[cbName]; }, 100);
            };
            const script = document.createElement('script');
            script.src = `https://suggestion.baidu.com/su?wd=${encodeURIComponent(keyword)}&json=1&p=3&cb=${cbName}`;
            script.onload = function () { setTimeout(() => { script.remove(); }, 100); };
            document.body.appendChild(script);
        }

        // 搜索建议
        function getSuggestions(keyword, callback) {
            getBaiduSuggestions(keyword, callback);
        }

        const searchInput = document.getElementById('search-input');
        const suggestionsBox = document.getElementById('search-suggestions');

        // 执行搜索功能
        function performSearch() {
            const keyword = searchInput.value.trim();
            if (!keyword) return;

            // 调用search-engine.js中的函数处理搜索
            window.saveSearchHistory(keyword);
        }

        // 展示建议和历史
        function showSuggestions() {
            const val = searchInput.value.trim();
            getSuggestions(val, function (suggestions) {
                let history = searchHistory.filter(h => h.includes(val)).slice(-5).reverse();
                let html = '';
                if (suggestions.length) {
                    html += '<div class="suggestion-title">搜索建议<div class="engine-icons"><img src="serve/files/icon/百度.svg" alt="百度" class="engine-icon" data-engine="baidu" title="百度" /><img src="serve/files/icon/谷歌.svg" alt="谷歌" class="engine-icon" data-engine="google" title="谷歌" /><img src="serve/files/icon/必应 .svg" alt="必应" class="engine-icon" data-engine="bing" title="必应" /><img src="serve/files/icon/搜狗.svg" alt="搜狗" class="engine-icon" data-engine="sogou" title="搜狗" /><img src="serve/files/icon/360so.svg" alt="360搜索" class="engine-icon" data-engine="360" title="360搜索" /></div></div>';
                    suggestions.forEach(s => {
                        html += `<div class=\"suggestion-item\">${s}</div>`;
                    });
                }
                if (history.length) {
                    html += '<div class="history-title">历史记录<div class="engine-icons"><img src="serve/files/icon/百度.svg" alt="百度" class="engine-icon" data-engine="baidu" title="百度" /><img src="serve/files/icon/谷歌.svg" alt="谷歌" class="engine-icon" data-engine="google" title="谷歌" /><img src="serve/files/icon/必应 .svg" alt="必应" class="engine-icon" data-engine="bing" title="必应" /><img src="serve/files/icon/搜狗.svg" alt="搜狗" class="engine-icon" data-engine="sogou" title="搜狗" /><img src="serve/files/icon/360so.svg" alt="360搜索" class="engine-icon" data-engine="360" title="360搜索" /></div></div>';

                    // 添加历史记录项
                    history.forEach(h => {
                        html += `<div class="history-item" data-search="${h}">${h}</div>`;
                    });
                }
                suggestionsBox.innerHTML = html;

                // 为搜索建议项和历史记录项添加动画
                function animateItems() {
                    const suggestionItems = document.querySelectorAll('.suggestion-item');
                    const historyItems = document.querySelectorAll('.history-item');
                    const allItems = [...suggestionItems, ...historyItems];

                    allItems.forEach((item, index) => {
                        setTimeout(() => {
                            item.classList.add('show');
                        }, 50 * index); // 每个项延迟50ms显示，创建依次出现的效果
                    });
                }

                // 根据当前搜索引擎设置图标活跃状态
                const currentEngineIcon = document.querySelector(`.engine-icon[data-engine="${currentSearchEngine}"]`);
                if (currentEngineIcon) {
                    // 移除所有活跃状态
                    document.querySelectorAll('.engine-icon').forEach(i => i.classList.remove('active'));
                    // 设置当前图标为活跃
                    currentEngineIcon.classList.add('active');
                }

                // 调用动画函数
                animateItems();

                // 添加搜索引擎选择器的事件监听
                const engineSelector = document.getElementById('history-engine-selector');

                // 添加搜索引擎图标点击事件
                const engineIcons = document.querySelectorAll('.engine-icon');
                engineIcons.forEach(icon => {
                    icon.addEventListener('click', function (e) {
                        e.stopPropagation();
                        const engine = this.getAttribute('data-engine');
                        // 移除所有活跃状态
                        document.querySelectorAll('.engine-icon').forEach(i => i.classList.remove('active'));
                        // 设置当前图标为活跃
                        this.classList.add('active');

                        // 设置当前搜索引擎
                        currentSearchEngine = engine;
                        // 保存搜索引擎设置到localStorage
                        localStorage.setItem('currentSearchEngine', currentSearchEngine);
                        console.log('切换搜索引擎为:', currentSearchEngine);
                    });
                });

                // 更新历史记录项的点击事件
                const historyItems = document.querySelectorAll('.history-item[data-search]');
                historyItems.forEach(item => {
                    item.addEventListener('click', function () {
                        const keyword = this.getAttribute('data-search');
                        if (keyword) {
                            // 根据选择的搜索引擎构建搜索URL
                            let searchUrl;
                            switch (currentSearchEngine) {
                                case 'google':
                                    searchUrl = 'https://www.google.com/search?q=' + encodeURIComponent(keyword);
                                    break;
                                case 'bing':
                                    searchUrl = 'https://www.bing.com/search?q=' + encodeURIComponent(keyword);
                                    break;
                                case 'sogou':
                                    searchUrl = 'https://www.sogou.com/web?query=' + encodeURIComponent(keyword);
                                    break;
                                case '360':
                                    searchUrl = 'https://www.so.com/s?q=' + encodeURIComponent(keyword);
                                    break;
                                default: // baidu
                                    searchUrl = 'https://www.baidu.com/s?wd=' + encodeURIComponent(keyword);
                            }

                            // 打开搜索结果
                            window.open(searchUrl, '_blank');

                            // 关闭搜索建议框
                            suggestionsBox.style.display = 'none';
                        }
                    });
                })
                if (html) {
                    suggestionsBox.style.display = 'block';
                    setTimeout(() => {
                        suggestionsBox.classList.add('show');
                    }, 10);
                } else {
                    suggestionsBox.classList.remove('show');
                    setTimeout(() => {
                        suggestionsBox.style.display = 'none';
                    }, 350);
                }
            });
        }

        searchInput.addEventListener('input', showSuggestions);
        searchInput.addEventListener('focus', showSuggestions);
        searchInput.addEventListener('blur', () => {
            suggestionsBox.classList.remove('show');
            setTimeout(() => { suggestionsBox.style.display = 'none'; }, 350);
        });
        // 右键时隐藏建议/历史下拉，避免冲突
        searchInput.addEventListener('contextmenu', () => {
            suggestionsBox.classList.remove('show');
            setTimeout(() => { suggestionsBox.style.display = 'none'; }, 350);
        });

        suggestionsBox.addEventListener('mousedown', function (e) {
            if (e.target.classList.contains('suggestion-item') || e.target.classList.contains('history-item')) {
                searchInput.value = e.target.textContent;
                suggestionsBox.style.display = 'none';
            }
        });

        // 回车搜索
        searchInput.addEventListener('keydown', function (e) {
            if (e.key === 'Enter') {
                performSearch();
            }
        });

    </script>
    <!-- logo动画 -->
    <video id="logo-video" src="./serve/files/logo/logo.mp4" autoplay muted playsinline
        style="width:100%;height:100%;z-index:9999999999;object-fit:cover;pointer-events:none;position:fixed;top:0;left:0;display:none;"></video>
    <script>
        const video = document.getElementById('logo-video');
        if (!localStorage.getItem('logoPlayed')) {
            video.style.display = '';
            video.play();
            video.addEventListener('ended', function () {
                video.classList.add('fade-out');
                setTimeout(function () {
                    video.style.display = 'none';
                    localStorage.setItem('logoPlayed', 'true');
                }, 600); // 渐隐动画持续时间
            });
        }
    </script>
    <!-- 壁纸服务 -->
    <video id="wallpaper-video" src="./users/files/videos/wallpaper.mp4" autoplay loop muted playsinline
        style="width:100%;height:100%;object-fit:cover;pointer-events:none;position:fixed;top:0;left:0;"></video>
    <!-- 任务栏 -->
    <div id="dock">
        <!-- 徽标 -->
        <div id="logo">
            <div class="muse-flutter-logo"
                style="display: flex; align-items: center; justify-content: center; height: 30px; width: 110px; color: white; font-family: 'Chillax', sans-serif; font-size: 16px; font-weight: bold;">
                MuseFlutter
            </div>
        </div>
        <!-- 图标 -->
        <div id="apps"></div>
        <!-- 更多 -->
        <div id="more" onclick="toggleSearchContainer()">
            <img src="./serve/files/icon/zk-ico.png"
                style="width: 100%; height: 100%; object-fit: contain; cursor: pointer; transition: transform 0.3s ease;">
        </div>

        <!-- 时间 -->
        <div id="time" class="time-component">
            <div class="clock" id="clock-display"></div>
            <div class="time-content">
                <div class="flip-container">
                    <div class="flipper">
                        <div class="front"></div>
                        <div class="back"></div>
                    </div>
                </div>
                <div class="date" id="date-display"></div>
            </div>
        </div>
        <!-- 空白 -->
        <div id="hide"></div>
    </div>

    <style>
        /* 壁纸动画和聚光灯效果 */
        #wallpaper-video {
            transition: transform 0.8s ease-out;
            transform: scale(1.8);
        }
        
        #wallpaper-video.animate-in {
            transform: scale(1);
        }
        
        /* 聚光灯效果 */
        .spotlight-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: radial-gradient(circle at center, transparent 3%, rgba(0, 0, 0, 1) 100%);
            z-index: 999;
            opacity: 1;
            transition: opacity 0.8s ease-out;
            pointer-events: none;
        }
        
        .spotlight-overlay.fade-out {
            opacity: 0;
        }
    </style>
    
    <!-- 聚光灯覆盖层 -->
    <div class="spotlight-overlay"></div>
    
    <script>
        // 全局配置：默认使用12小时制
        let use12HourFormat = true;
        let searchContainerVisible = true; // 搜索框初始可见状态

        // 切换搜索框显示/隐藏
        function toggleSearchContainer() {
            const searchIcon = document.querySelector('#more img');
            const searchContainer = document.getElementById('search-container');

            // 确保搜索框有过渡效果
            searchContainer.style.transition = 'all 0.3s cubic-bezier(0.18, 0.89, 0.32, 1.28)';

            if (searchContainerVisible) {
                // 隐藏搜索框
                searchContainer.style.opacity = '0';
                searchContainer.style.filter = 'blur(10px)';
                searchContainer.style.transform = 'translate(-50%, -50%) scale(0.9) translateY(-20px)';
                // 旋转图标180度（关闭状态）
                searchIcon.style.transform = 'rotate(180deg)';
            } else {
                // 显示搜索框
                searchContainer.style.display = 'flex';
                // 使用setTimeout确保display变更后动画能正常触发
                setTimeout(() => {
                    searchContainer.style.opacity = '1';
                    searchContainer.style.filter = 'blur(0px)';
                    searchContainer.style.transform = 'translate(-50%, -50%) scale(1) translateY(0)';
                }, 10);
                // 旋转图标0度（打开状态）
                searchIcon.style.transform = 'rotate(0deg)';
            }
            searchContainerVisible = !searchContainerVisible;


            // 已统一到上方逻辑中
        }

        // 初始隐藏搜索框（可选）
        // document.addEventListener('DOMContentLoaded', function() {
        //     searchContainerVisible = false;
        //     document.getElementById('search-container').style.display = 'none';
        // });

        function updateTime() {
            const now = new Date();
            const year = now.getFullYear();
            const month = String(now.getMonth() + 1).padStart(2, '0');
            const day = String(now.getDate()).padStart(2, '0');

            let hour = now.getHours();
            let timeDisplay = '';

            if (use12HourFormat) {
                // 12小时制
                const ampm = hour >= 12 ? 'PM' : 'AM';
                hour = hour % 12;
                hour = hour ? hour : 12; // 0点变为12点
                const hourStr = String(hour).padStart(2, '0');
                timeDisplay = `${hourStr}:${String(now.getMinutes()).padStart(2, '0')} ${ampm}`;
            } else {
                // 24小时制
                timeDisplay = `${String(hour).padStart(2, '0')}:${String(now.getMinutes()).padStart(2, '0')}`;
            }

            document.getElementById('clock-display').textContent = timeDisplay;
            document.getElementById('date-display').textContent = `${month}-${day}`;
            const weekDays = ['周日', '周一', '周二', '周三', '周四', '周五', '周六'];
            const dayOfWeek = weekDays[now.getDay()];
            document.querySelector('.front').textContent = dayOfWeek;
            document.querySelector('.back').textContent = year;
        }
        // 初始化时间组件右键菜单
        function initTimeComponentContextMenu() {
            // 创建时间组件专用右键菜单
            const timeContextMenu = document.createElement('div');
            timeContextMenu.id = 'time-context-menu';
            timeContextMenu.className = 'custom-context-menu';
            timeContextMenu.style.position = 'fixed';
            timeContextMenu.style.display = 'none';
            timeContextMenu.style.zIndex = '100001';
            timeContextMenu.style.backgroundColor = 'rgba(255, 255, 255, 0.1)';
            timeContextMenu.style.backdropFilter = 'blur(12px)';
            timeContextMenu.style.border = '1px solid rgba(255, 255, 255, 0.2)';
            timeContextMenu.style.borderRadius = '10px';
            timeContextMenu.style.padding = '5px 0';
            timeContextMenu.style.minWidth = '180px';
            document.body.appendChild(timeContextMenu);

            // 添加复制时间菜单项
            const copyTimeItem = document.createElement('div');
            copyTimeItem.className = 'context-menu-item';
            copyTimeItem.innerHTML = '<svg class="context-menu-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="20" height="20" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path></svg>复制时间';
            copyTimeItem.addEventListener('click', () => {
                try {
                    const timeText = document.getElementById('clock-display').textContent;
                    navigator.clipboard.writeText(timeText);
                    timeContextMenu.style.display = 'none';
                } catch (err) {
                    console.error('复制失败:', err);
                }
            });
            timeContextMenu.appendChild(copyTimeItem);

            // 添加复制日期菜单项
            const copyDateItem = document.createElement('div');
            copyDateItem.className = 'context-menu-item';
            copyDateItem.innerHTML = '<svg class="context-menu-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="20" height="20" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path></svg>复制日期';
            copyDateItem.addEventListener('click', () => {
                try {
                    const dateText = document.getElementById('date-display').textContent;
                    const dayOfWeek = document.querySelector('.front').textContent;
                    const year = document.querySelector('.back').textContent;
                    navigator.clipboard.writeText(`${year}年${dateText.replace('-', '月')}日 ${dayOfWeek}`);
                    timeContextMenu.style.display = 'none';
                } catch (err) {
                    console.error('复制失败:', err);
                }
            });
            timeContextMenu.appendChild(copyDateItem);

            // 仅时间组件添加时间格式切换菜单项
            const formatToggleItem = document.createElement('div');
            formatToggleItem.className = 'context-menu-item';
            formatToggleItem.innerHTML = `<svg class="context-menu-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="20" height="20" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"></circle><polyline points="12 6 12 12 16 14"></polyline></svg>${use12HourFormat ? '切换到24小时制' : '切换到12小时制'}`;
            formatToggleItem.addEventListener('click', () => {
                use12HourFormat = !use12HourFormat;
                formatToggleItem.innerHTML = `<svg class="context-menu-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="20" height="20" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"></circle><polyline points="12 6 12 12 16 14"></polyline></svg>${use12HourFormat ? '切换到24小时制' : '切换到12小时制'}`;
                updateTime();
                // 应用关闭动画
                timeContextMenu.classList.add('closing');
                setTimeout(() => {
                    timeContextMenu.style.display = 'none';
                    timeContextMenu.classList.remove('closing');
                }, 200);
            });
            timeContextMenu.appendChild(formatToggleItem);

            // 初始化通知系统
            function initNotificationSystem() {
                // 创建通知容器
                let notificationContainer = document.getElementById('notification-container');
                if (!notificationContainer) {
                    notificationContainer = document.createElement('div');
                    notificationContainer.id = 'notification-container';
                    notificationContainer.className = 'notification-container';
                    document.body.appendChild(notificationContainer);
                }

                // 创建提示容器
                let promptContainer = document.getElementById('prompt-container');
                if (!promptContainer) {
                    promptContainer = document.createElement('div');
                    promptContainer.id = 'prompt-container';
                    promptContainer.className = 'prompt-container';
                    document.body.appendChild(promptContainer);
                }

                // 全局通知管理器
                window.notificationManager = {
                    // 显示通知
                    showNotification: function (options) {
                        const { title, icon, content, timestamp = new Date(), image, buttons = [] } = options;

                        // 创建通知元素
                        const notification = document.createElement('div');
                        notification.className = 'notification';

                        // 生成时间字符串
                        const timeStr = timestamp.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });

                        // 构建通知内容
                        let notificationHTML = `
                        <div class="notification-header">
                            <div class="notification-title">
                                ${icon ? `<img src="${icon}" class="notification-icon" alt="${title}">` : ''}
                                ${title}
                            </div>
                            <div class="notification-time">${timeStr}</div>
                        </div>
                    `;

                        // 添加内容
                        if (content) {
                            notificationHTML += `
                            <div class="notification-content">${content}</div>
                        `;
                        }

                        // 添加图片
                        if (image) {
                            notificationHTML += `
                            <img src="${image}" class="notification-image" alt="Notification image">
                        `;
                        }

                        // 添加按钮
                        if (buttons.length > 0) {
                            notificationHTML += `
                            <div class="notification-buttons">
                        `;

                            buttons.forEach((button, index) => {
                                const { text, primary = false, onClick } = button;
                                const buttonClass = primary ? 'notification-button primary' : 'notification-button';
                                const buttonId = `notification-button-${Date.now()}-${index}`;

                                notificationHTML += `
                                <button id="${buttonId}" class="${buttonClass}">${text}</button>
                            `;

                                // 延迟绑定点击事件
                                setTimeout(() => {
                                    const buttonElement = document.getElementById(buttonId);
                                    if (buttonElement && typeof onClick === 'function') {
                                        buttonElement.addEventListener('click', () => {
                                            onClick();
                                            this.closeNotification(notification);
                                        });
                                    }
                                }, 0);
                            });

                            notificationHTML += `
                            </div>
                        `;
                        }

                        // 设置通知内容
                        notification.innerHTML = notificationHTML;

                        // 添加到容器
                        notificationContainer.appendChild(notification);

                        // 点击通知关闭
                        notification.addEventListener('click', (e) => {
                            // 防止按钮点击事件冒泡
                            if (!e.target.closest('.notification-button')) {
                                this.closeNotification(notification);
                            }
                        });

                        // 自动关闭（5秒后）
                        setTimeout(() => {
                            this.closeNotification(notification);
                        }, 5000);

                        return notification;
                    },

                    // 关闭通知
                    closeNotification: function (notification) {
                        notification.classList.add('closing');
                        setTimeout(() => {
                            if (notification.parentNode === notificationContainer) {
                                notificationContainer.removeChild(notification);
                            }
                        }, 300);
                    },

                    // 显示提示
                    showPrompt: function (message, duration = 3000) {
                        // 创建提示元素
                        const prompt = document.createElement('div');
                        prompt.className = 'prompt';
                        prompt.textContent = message;

                        // 添加到容器
                        promptContainer.appendChild(prompt);

                        // 自动关闭
                        setTimeout(() => {
                            this.closePrompt(prompt);
                        }, duration);

                        return prompt;
                    },

                    // 关闭提示
                    closePrompt: function (prompt) {
                        prompt.classList.add('closing');
                        setTimeout(() => {
                            if (prompt.parentNode === promptContainer) {
                                promptContainer.removeChild(prompt);
                            }
                        }, 300);
                    }
                };

                // 初始化
                console.log('Notification system initialized');
            }

            // 页面加载完成后初始化通知系统
            document.addEventListener('DOMContentLoaded', initNotificationSystem);

            // 为时间和日期组件添加右键事件
            const timeComponent = document.getElementById('time');
            timeComponent.addEventListener('contextmenu', (e) => {
                e.preventDefault();
                e.stopPropagation();

                // 获取鼠标位置
                const x = e.clientX;
                const y = e.clientY;

                // 计算菜单位置，确保在屏幕范围内
                const menuWidth = timeContextMenu.offsetWidth || 180;
                const menuHeight = timeContextMenu.offsetHeight || 150;
                const screenWidth = window.innerWidth;
                const screenHeight = window.innerHeight;

                // 调整X坐标
                let left = x;
                if (x + menuWidth > screenWidth) {
                    left = screenWidth - menuWidth - 10;
                }

                // 调整Y坐标
                let top = y;
                if (y + menuHeight > screenHeight) {
                    top = screenHeight - menuHeight - 10;
                }

                // 显示右键菜单
                timeContextMenu.style.left = `${left}px`;
                timeContextMenu.style.top = `${top}px`;
                timeContextMenu.style.display = 'block';
            });

            // 点击其他地方关闭右键菜单
            document.addEventListener('click', (e) => {
                // 确保点击不是在菜单本身上
                if (!timeContextMenu.contains(e.target)) {
                    timeContextMenu.classList.add('closing');
                    setTimeout(() => {
                        timeContextMenu.style.display = 'none';
                        timeContextMenu.classList.remove('closing');
                    }, 200);
                }
            });
        }

        setInterval(updateTime, 1000);
        updateTime();
        initTimeComponentContextMenu();

        // 翻转效果逻辑
        const flipContainer = document.querySelector('.flip-container');
        let isFlipped = false;

        function flip() {
            isFlipped = !isFlipped;
            if (isFlipped) {
                flipContainer.classList.add('flipped');
            } else {
                flipContainer.classList.remove('flipped');
            }
        }

        // 为日期组件添加点击事件
        flipContainer.addEventListener('click', flip);




        // 每5秒翻转一次
        setInterval(flip, 5000);
    </script>


    <!-- 预设应用区域 -->
    <div id="preset-apps"
        style="position: fixed; bottom: 70px; left: 50%; transform: translateX(-50%); background: rgba(255, 255, 255, 0.1); backdrop-filter: blur(10px); padding: 10px; border-radius: 10px; z-index: 9999; display: none;">
        <h3 style="color: white; margin-bottom: 10px; text-align: center;">预设应用</h3>
        <div id="preset-apps-container" style="display: flex; flex-wrap: wrap; justify-content: center; gap: 10px;">
            <!-- 预设应用将通过JS动态加载 -->
        </div>
    </div>

    <!-- 引入JS -->
    <script src="./serve/js/index.js"></script>
    <script src="./serve/js/window.js"></script>
    <script>
        // 初始化应用
        window.addEventListener('DOMContentLoaded', () => {

            // 创建自定义窗口的函数
            window.createCustomWindow = function (options) {
                const newWindow = new RoundedWindow({
                    title: options.title,
                    icon: options.icon,
                    url: options.url,
                    content: options.content,
                    width: 350,
                    height: 570,
                    x: 1,
                    y: 1,
                    isCustom: true
                });
                return newWindow;
            }

            // 使用现有的hide元素作为关闭全部窗口按钮
            const hideBtn = document.getElementById('hide');
            hideBtn.style.cursor = 'pointer'; // 只保留光标样式，确保用户知道这是可点击的
            hideBtn.addEventListener('click', () => {
                if (window.windowManager && window.windowManager.windows) {
                    // 复制窗口列表以避免在迭代中修改
                    const windowsCopy = [...window.windowManager.windows];
                    windowsCopy.forEach(window => window.close());
                }
            });

            // 加载预设应用到右键菜单
            function loadPresetAppsToContextMenu() {
                const contextMenu = document.getElementById('custom-context-menu');
                if (!contextMenu) return;

                // 预设应用列表
                const presetApps = [
                    { name: '代码编辑器', file: 'code-editor.html', icon: './serve/files/icon/code-editor.svg' },
                    { name: '思维导图', file: 'mind-map.html', icon: './serve/files/icon/mind-map.svg' },
                    { name: '神秘书店', file: 'mystery-bookstore-gal.html', icon: './serve/files/icon/bookstore.svg' },
                    { name: '粒子物理', file: 'particle-physics.html', icon: './serve/files/icon/physics.svg' },
                    { name: '像素艺术', file: 'pixel-art.html', icon: './serve/files/icon/pixel-art.svg' },
                    { name: '像素编辑器', file: 'pixel-editor.html', icon: './serve/files/icon/pixel-editor.svg' },
                    { name: '程序员贪吃蛇', file: 'programmer-snake.html', icon: './serve/files/icon/snake.svg' },
                    { name: '节奏游戏', file: 'rhythm-game.html', icon: './serve/files/icon/music.svg' },
                    { name: '旅行日志', file: 'travel-log.html', icon: './serve/files/icon/travel.svg' },
                    { name: '空白HTML', file: 'about:blank', icon: './serve/files/icon/html.svg' }
                ];

                // 创建"新建"菜单项
                const newMenuItem = document.createElement('div');
                newMenuItem.className = 'context-menu-item';
                newMenuItem.innerHTML = '<svg class="context-menu-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 5v14M5 12h14"></path></svg>新建';
                contextMenu.appendChild(newMenuItem);

                // 创建"新建"子菜单
                const newSubMenu = document.createElement('div');
                newSubMenu.className = 'custom-context-menu submenu';
                newSubMenu.style.position = 'absolute';
                newSubMenu.style.display = 'none';
                document.body.appendChild(newSubMenu);

                // 显示子菜单
                newMenuItem.addEventListener('mouseenter', (e) => {
                    e.stopPropagation();
                    const rect = newMenuItem.getBoundingClientRect();

                    // 获取屏幕可视区域尺寸
                    const viewportWidth = window.innerWidth;
                    const viewportHeight = window.innerHeight;

                    // 计算子菜单的位置
                    let left = rect.right;
                    let top = rect.top;

                    // 强制显示子菜单以获取其尺寸
                    newSubMenu.style.display = 'block';
                    newSubMenu.style.visibility = 'hidden';
                    const subMenuRect = newSubMenu.getBoundingClientRect();

                    // 检查右侧边界
                    if (left + subMenuRect.width > viewportWidth) {
                        left = rect.left - subMenuRect.width;
                    }

                    // 检查底部边界
                    if (top + subMenuRect.height > viewportHeight) {
                        // 如果子菜单高度超过视口高度，调整顶部位置使其显示在可见区域
                        top = Math.max(0, viewportHeight - subMenuRect.height);
                    }

                    // 设置最终位置并显示
                    newSubMenu.style.left = `${left}px`;
                    newSubMenu.style.top = `${top}px`;
                    newSubMenu.style.visibility = 'visible';
                });

                // 隐藏子菜单
                newMenuItem.addEventListener('mouseleave', () => {
                    setTimeout(() => {
                        if (!newSubMenu.matches(':hover') && !newMenuItem.matches(':hover')) {
                            newSubMenu.style.display = 'none';
                        }
                    }, 300);
                });

                newSubMenu.addEventListener('mouseleave', () => {
                    setTimeout(() => {
                        if (!newSubMenu.matches(':hover') && !newMenuItem.matches(':hover')) {
                            newSubMenu.style.display = 'none';
                        }
                    }, 300);
                });

                // 添加预设应用菜单项到新建子菜单
                presetApps.forEach(app => {
                    const menuItem = document.createElement('div');
                    menuItem.className = 'context-menu-item';
                    menuItem.innerHTML = `<img src="${app.icon}" alt="${app.name}" class="context-menu-icon">${app.name}`;
                    menuItem.addEventListener('click', () => {
                        window.createCustomWindow({
                            title: app.name,
                            icon: app.icon,
                            url: app.file === 'about:blank' ? 'about:blank' : `./users/applications/${app.file}`
                        });
                        // 应用关闭动画
                        contextMenu.classList.add('closing');
                        setTimeout(() => {
                            contextMenu.style.display = 'none';
                            contextMenu.classList.remove('closing');
                        }, 200);
                        newSubMenu.style.display = 'none';
                    });
                    newSubMenu.appendChild(menuItem);
                });
            }

            // 初始化右键菜单
            function initContextMenu() {
                // 创建右键菜单元素
                const contextMenu = document.createElement('div');
                contextMenu.id = 'custom-context-menu';
                contextMenu.className = 'custom-context-menu';
                contextMenu.style.position = 'fixed';
                contextMenu.style.display = 'none';
                contextMenu.style.zIndex = '999999'; // 保证菜单在所有元素之上
                contextMenu.style.backgroundColor = 'rgba(255, 255, 255, 0.1)';
                contextMenu.style.backdropFilter = 'blur(12px)';
                contextMenu.style.border = '1px solid rgba(255, 255, 255, 0.2)';
                contextMenu.style.borderRadius = '10px';
                contextMenu.style.padding = '5px 0';
                contextMenu.style.minWidth = '180px';
                document.body.appendChild(contextMenu);

                // 添加系统功能菜单
                function addSystemMenuItems() {
                    // 创建系统菜单容器
                    const systemMenuContainer = document.createElement('div');
                    systemMenuContainer.className = 'windows11-system-menu';
                    contextMenu.appendChild(systemMenuContainer);

                    // 复制
                    const copyItem = document.createElement('div');
                    copyItem.className = 'context-menu-item windows11-item';
                    copyItem.innerHTML = '<svg class="context-menu-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="20" height="20" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path></svg><span class="windows11-item-text">复制</span>';
                    copyItem.addEventListener('click', () => {
                        try {
                            let showTip = false;
                            if (lastInputTarget && typeof lastInputTarget.selectionStart === 'number') {
                                if (lastInputTarget.selectionStart !== lastInputTarget.selectionEnd) {
                                    document.execCommand('copy');
                                    showTip = true;
                                }
                            } else {
                                document.execCommand('copy');
                                showTip = true;
                            }
                            if (showTip) {
                                window.notificationManager.showPrompt('已复制到剪贴板', 2000);
                            }
                            contextMenu.classList.add('closing');
                            setTimeout(() => {
                                contextMenu.classList.remove('closing');
                            }, 200);
                        } catch (err) {
                            console.error('复制失败:', err);
                            window.notificationManager.showPrompt('复制失败', 2000);
                        }
                    });
                    systemMenuContainer.appendChild(copyItem);

                    // 粘贴
                    const pasteItem = document.createElement('div');
                    pasteItem.className = 'context-menu-item windows11-item';
                    pasteItem.innerHTML = '<svg class="context-menu-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="20" height="20" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="12" y="12" width="13" height="13" rx="2" ry="2"></rect><path d="M19 17V5a2 2 0 0 0-2-2H5a2 2 0 0 0-2 2v16l7-5 7 5z"></path></svg><span class="windows11-item-text">粘贴</span>';
                    pasteItem.addEventListener('click', () => {
                        try {
                            navigator.clipboard.readText().then(text => {
                                if (text) {
                                    document.execCommand('paste');
                                    window.notificationManager.showPrompt('已粘贴内容', 2000);
                                }
                                contextMenu.classList.add('closing');
                                setTimeout(() => {
                                    contextMenu.classList.remove('closing');
                                }, 200);
                            });
                        } catch (err) {
                            console.error('粘贴失败:', err);
                            window.notificationManager.showPrompt('粘贴失败', 2000);
                        }
                    });
                    systemMenuContainer.appendChild(pasteItem);

                    // 剪切
                    const cutItem = document.createElement('div');
                    cutItem.className = 'context-menu-item windows11-item';
                    cutItem.innerHTML = '<svg class="context-menu-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="20" height="20" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M14 17H7a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5"></path><line x1="16" y1="17" x2="16" y2="13"></line><line x1="8" y1="13" x2="16" y2="13"></line><line x1="18" y1="13" x2="20" y2="13"></line><line x1="18" y1="11" x2="20" y2="11"></line></svg><span class="windows11-item-text">剪切</span>';
                    cutItem.addEventListener('click', () => {
                        try {
                            let showTip = false;
                            if (lastInputTarget && typeof lastInputTarget.selectionStart === 'number') {
                                if (lastInputTarget.selectionStart !== lastInputTarget.selectionEnd) {
                                    document.execCommand('cut');
                                    showTip = true;
                                }
                            } else {
                                document.execCommand('cut');
                                showTip = true;
                            }
                            if (showTip) {
                                window.notificationManager.showPrompt('已剪切内容', 2000);
                            }
                            contextMenu.classList.add('closing');
                            setTimeout(() => {
                                contextMenu.classList.remove('closing');
                            }, 200);
                        } catch (err) {
                            console.error('剪切失败:', err);
                            window.notificationManager.showPrompt('剪切失败', 2000);
                        }
                    });
                    systemMenuContainer.appendChild(cutItem);
                }

                // 全局拦截右键菜单，始终显示自定义菜单（包括输入框）
                let lastInputTarget = null;
                document.addEventListener('contextmenu', (e) => {
                    e.preventDefault();
                    // 判断是否为输入框或可编辑区域
                    const tag = e.target.tagName.toLowerCase();
                    if (tag === 'input' || tag === 'textarea' || e.target.isContentEditable) {
                        lastInputTarget = e.target;
                    } else {
                        lastInputTarget = null;
                    }
                    showContextMenu(e.clientX, e.clientY);
                });

                // 添加移动端长按支持
                let pressTimer;
                let isDragging = false;
                let startX, startY, menuStartX, menuStartY;
                let touchStartX, touchStartY;

                // 创建移动端长按菜单
                const mobileContextMenu = document.createElement('div');
                mobileContextMenu.id = 'mobile-context-menu';
                mobileContextMenu.className = 'mobile-context-menu';
                document.body.appendChild(mobileContextMenu);

                // 初始化移动端菜单
                function initMobileContextMenu() {
                    // 清空菜单
                    mobileContextMenu.innerHTML = '';

                    // 添加新建窗口菜单项
                    const newWindowItem = document.createElement('div');
                    newWindowItem.className = 'mobile-context-menu-item';
                    newWindowItem.innerHTML = '<div class="mobile-menu-icon"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="20" height="20" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect><line x1="3" y1="9" x2="21" y2="9"></line><line x1="9" y1="21" x2="9" y2="9"></line></svg></div>新建窗口';
                    newWindowItem.addEventListener('click', () => {
                        window.createCustomWindow({
                            title: '空白窗口',
                            url: 'about:blank'
                        });
                        mobileContextMenu.classList.remove('show');
                    });
                    mobileContextMenu.appendChild(newWindowItem);

                    // 添加应用列表菜单项
                    const appsItem = document.createElement('div');
                    appsItem.className = 'mobile-context-menu-item';
                    appsItem.innerHTML = '<div class="mobile-menu-icon"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="20" height="20" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect><circle cx="8.5" cy="8.5" r="1.5"></circle><polyline points="21 15 16 10 5 21"></polyline></svg></div>应用列表';
                    appsItem.addEventListener('click', () => {
                        const presetAppsContainer = document.getElementById('preset-apps-container');
                        if (presetAppsContainer) {
                            if (presetAppsContainer.style.display === 'none' || !presetAppsContainer.style.display) {
                                presetAppsContainer.style.display = 'flex';
                            } else {
                                presetAppsContainer.style.display = 'none';
                            }
                        }
                        mobileContextMenu.classList.remove('show');
                    });
                    mobileContextMenu.appendChild(appsItem);

                    // 添加桌宠设置菜单项
                    const petItem = document.createElement('div');
                    petItem.className = 'mobile-context-menu-item';
                    petItem.innerHTML = '<div class="mobile-menu-icon"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="20" height="20" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-1 17.93c-3.95-.49-7-3.85-7-7.93 0-.62.08-1.21.21-1.79L9 15v1c0 1.1.9 2 2 2v1.93zm6.9-2.54c-.26-.81-1-1.39-1.9-1.39h-1v-3c0-.55-.45-1-1-1H8v-2h2c.55 0 1-.45 1-1V7h2c1.1 0 2-.9 2-2v-.41c2.93 1.19 5 4.06 5 7.41 0 2.08-.8 3.97-2.1 5.39z"></svg></div>桌宠设置';
                    petItem.addEventListener('click', () => {
                        if (window.desktopPet) {
                            // 切换桌宠可见状态
                            const petElement = window.desktopPet.element;
                            if (petElement.style.display === 'none' || !petElement.style.display) {
                                petElement.style.display = 'block';
                            } else {
                                petElement.style.display = 'none';
                            }
                        }
                        mobileContextMenu.classList.remove('show');
                    });
                    mobileContextMenu.appendChild(petItem);

                    // 添加分隔线
                    const divider = document.createElement('div');
                    divider.className = 'mobile-context-menu-divider';
                    mobileContextMenu.appendChild(divider);

                    // 添加刷新菜单项
                    const refreshItem = document.createElement('div');
                    refreshItem.className = 'mobile-context-menu-item';
                    refreshItem.innerHTML = '<div class="mobile-menu-icon"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="20" height="20" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 12a9 9 0 0 1 9-9 9.75 9.75 0 0 1 6.74 2.74L21 8"></path><path d="M21 3v5h-5"></path><path d="M21 12a9 9 0 0 1-9 9 9.75 9.75 0 0 1-6.74-2.74L3 16"></path><path d="M3 21v-5h5"></path></svg></div>刷新页面';
                    refreshItem.addEventListener('click', () => {
                        location.reload();
                    });
                    mobileContextMenu.appendChild(refreshItem);
                }

                // 初始化移动端菜单
                initMobileContextMenu();

                // 显示移动端菜单
                function showMobileContextMenu(x, y) {
                    // 先显示菜单以获取准确尺寸
                    mobileContextMenu.style.display = 'block';
                    mobileContextMenu.style.visibility = 'hidden';

                    // 计算菜单位置，确保在屏幕范围内
                    const menuWidth = mobileContextMenu.offsetWidth;
                    const menuHeight = mobileContextMenu.offsetHeight;
                    const screenWidth = window.innerWidth;
                    const screenHeight = window.innerHeight;

                    // 调整X坐标
                    let left = x;
                    if (x + menuWidth > screenWidth) {
                        left = screenWidth - menuWidth - 10;
                    }

                    // 调整Y坐标
                    let top = y;
                    if (y + menuHeight > screenHeight) {
                        top = screenHeight - menuHeight - 10;
                    }

                    // 确保菜单在屏幕可见区域内
                    top = Math.max(0, Math.min(top, screenHeight - menuHeight));
                    left = Math.max(0, Math.min(left, screenWidth - menuWidth));

                    // 设置菜单位置并显示
                    mobileContextMenu.style.left = `${left}px`;
                    mobileContextMenu.style.top = `${top}px`;
                    mobileContextMenu.style.visibility = 'visible';

                    // 添加显示动画
                    setTimeout(() => {
                        mobileContextMenu.classList.add('show');
                    }, 10);
                }

                // 长按开始
                document.addEventListener('touchstart', (e) => {
                    if (e.touches.length === 1) {
                        const touch = e.touches[0];
                        touchStartX = touch.clientX;
                        touchStartY = touch.clientY;

                        pressTimer = setTimeout(() => {
                            // 检查是否有明显移动
                            if (Math.abs(touch.clientX - touchStartX) < 10 && Math.abs(touch.clientY - touchStartY) < 10) {
                                e.preventDefault();
                                // 隐藏桌面菜单
                                contextMenu.style.display = 'none';
                                // 显示移动端菜单
                                showMobileContextMenu(touch.clientX, touch.clientY);
                            }
                        }, 500); // 移动端长按时间更短
                    }
                }, { passive: false });

                // 移动或释放时取消计时器
                document.addEventListener('touchmove', (e) => {
                    if (pressTimer && e.touches.length === 1) {
                        const touch = e.touches[0];
                        // 如果移动超过阈值，取消长按
                        if (Math.abs(touch.clientX - touchStartX) > 10 || Math.abs(touch.clientY - touchStartY) > 10) {
                            clearTimeout(pressTimer);
                        }
                    }
                });

                document.addEventListener('touchend', () => {
                    clearTimeout(pressTimer);
                });

                // 点击其他地方关闭移动端菜单
                document.addEventListener('click', (e) => {
                    if (!mobileContextMenu.contains(e.target)) {
                        mobileContextMenu.classList.remove('show');
                        setTimeout(() => {
                            if (!mobileContextMenu.classList.contains('show')) {
                                mobileContextMenu.style.display = 'none';
                            }
                        }, 200);
                    }
                });

                // 移动端菜单拖动功能
                mobileContextMenu.addEventListener('touchstart', (e) => {
                    if (e.target === mobileContextMenu || e.target.classList.contains('mobile-context-menu')) {
                        isDragging = true;
                        const touch = e.touches[0];
                        startX = touch.clientX;
                        startY = touch.clientY;
                        menuStartX = parseInt(mobileContextMenu.style.left) || 0;
                        menuStartY = parseInt(mobileContextMenu.style.top) || 0;
                        e.preventDefault();
                    }
                });

                document.addEventListener('touchmove', (e) => {
                    if (isDragging) {
                        const touch = e.touches[0];
                        const dx = touch.clientX - startX;
                        const dy = touch.clientY - startY;
                        const newLeft = menuStartX + dx;
                        const newTop = menuStartY + dy;

                        // 确保菜单不超出屏幕
                        const screenWidth = window.innerWidth;
                        const screenHeight = window.innerHeight;
                        const menuWidth = mobileContextMenu.offsetWidth || 220;
                        const menuHeight = mobileContextMenu.offsetHeight || 300;

                        const boundedLeft = Math.max(0, Math.min(newLeft, screenWidth - menuWidth));
                        const boundedTop = Math.max(0, Math.min(newTop, screenHeight - menuHeight));

                        mobileContextMenu.style.left = `${boundedLeft}px`;
                        mobileContextMenu.style.top = `${boundedTop}px`;
                    }
                });

                document.addEventListener('touchend', () => {
                    isDragging = false;
                });

                // 显示右键菜单的通用函数
                function showContextMenu(x, y) {
                    // 先显示菜单以获取准确尺寸
                    contextMenu.style.display = 'block';
                    contextMenu.style.visibility = 'hidden';

                    // 计算菜单位置，确保在屏幕范围内
                    const menuWidth = contextMenu.offsetWidth;
                    const menuHeight = contextMenu.offsetHeight;
                    const screenWidth = window.innerWidth;
                    const screenHeight = window.innerHeight;

                    // 获取任务栏元素和尺寸
                    const dock = document.getElementById('dock');
                    let dockRect = null;
                    if (dock) {
                        dockRect = dock.getBoundingClientRect();
                    }

                    // 调整X坐标
                    let left = x;
                    if (x + menuWidth > screenWidth) {
                        left = screenWidth - menuWidth - 10;
                    }

                    // 调整Y坐标
                    let top = y;

                    // 如果点击了任务栏，特别处理Y坐标
                    if (dockRect && y >= dockRect.top && y <= dockRect.bottom) {
                        // 任务栏在底部
                        if (dockRect.bottom === screenHeight) {
                            top = dockRect.top - menuHeight - 5;
                        }
                        // 任务栏在顶部
                        else if (dockRect.top === 0) {
                            top = dockRect.bottom + 5;
                        }
                    } else if (y + menuHeight > screenHeight) {
                        top = screenHeight - menuHeight - 10;
                    }

                    // 确保菜单在屏幕可见区域内
                    top = Math.max(0, Math.min(top, screenHeight - menuHeight));
                    left = Math.max(0, Math.min(left, screenWidth - menuWidth));

                    // 设置菜单位置并显示
                    contextMenu.style.left = `${left}px`;
                    contextMenu.style.top = `${top}px`;
                    contextMenu.style.visibility = 'visible';

                    // 查找菜单按钮
                    let copyBtn = null, pasteBtn = null, cutBtn = null;
                    const items = contextMenu.querySelectorAll('.windows11-item');
                    items.forEach(btn => {
                        const txt = btn.textContent.trim();
                        if (txt.includes('复制')) copyBtn = btn;
                        if (txt.includes('粘贴')) pasteBtn = btn;
                        if (txt.includes('剪切')) cutBtn = btn;
                    });
                    if (lastInputTarget) {
                        if (copyBtn) {
                            copyBtn.onclick = function () {
                                // 只复制选中内容
                                if (lastInputTarget.selectionStart !== lastInputTarget.selectionEnd) {
                                    document.execCommand('copy');
                                } else {
                                    lastInputTarget.select();
                                    document.execCommand('copy');
                                }
                                contextMenu.style.display = 'none';
                            };
                            copyBtn.classList.remove('disabled');
                        }
                        if (pasteBtn) {
                            pasteBtn.onclick = function () {
                                lastInputTarget.focus();
                                navigator.clipboard.readText().then(text => {
                                    if (typeof lastInputTarget.setRangeText === 'function') {
                                        lastInputTarget.setRangeText(text, lastInputTarget.selectionStart, lastInputTarget.selectionEnd, 'end');
                                    } else {
                                        lastInputTarget.value += text;
                                    }
                                });
                                contextMenu.style.display = 'none';
                            };
                            pasteBtn.classList.remove('disabled');
                        }
                        if (cutBtn) {
                            cutBtn.onclick = function () {
                                // 只剪切选中内容
                                if (lastInputTarget.selectionStart !== lastInputTarget.selectionEnd) {
                                    document.execCommand('cut');
                                } else {
                                    lastInputTarget.select();
                                    document.execCommand('cut');
                                }
                                contextMenu.style.display = 'none';
                            };
                            cutBtn.classList.remove('disabled');
                        }
                    } else {
                        [copyBtn, pasteBtn, cutBtn].forEach(btn => {
                            if (btn) {
                                btn.onclick = null;
                                btn.classList.add('disabled');
                            }
                        });
                    }
                }

                // 添加菜单拖动功能
                contextMenu.addEventListener('mousedown', (e) => {
                    if (e.target === contextMenu || e.target.classList.contains('custom-context-menu')) {
                        isDragging = true;
                        startX = e.clientX;
                        startY = e.clientY;
                        menuStartX = parseInt(contextMenu.style.left) || 0;
                        menuStartY = parseInt(contextMenu.style.top) || 0;
                        e.preventDefault();
                    }
                });

                document.addEventListener('mousemove', (e) => {
                    if (isDragging) {
                        const dx = e.clientX - startX;
                        const dy = e.clientY - startY;
                        const newLeft = menuStartX + dx;
                        const newTop = menuStartY + dy;

                        // 确保菜单不超出屏幕
                        const screenWidth = window.innerWidth;
                        const screenHeight = window.innerHeight;
                        const menuWidth = contextMenu.offsetWidth || 180;
                        const menuHeight = contextMenu.offsetHeight || 300;

                        const boundedLeft = Math.max(0, Math.min(newLeft, screenWidth - menuWidth));
                        const boundedTop = Math.max(0, Math.min(newTop, screenHeight - menuHeight));

                        contextMenu.style.left = `${boundedLeft}px`;
                        contextMenu.style.top = `${boundedTop}px`;
                    }
                });

                document.addEventListener('mouseup', () => {
                    isDragging = false;
                });

                // 移动端触摸拖动
                contextMenu.addEventListener('touchstart', (e) => {
                    if (e.target === contextMenu || e.target.classList.contains('custom-context-menu')) {
                        isDragging = true;
                        const touch = e.touches[0];
                        startX = touch.clientX;
                        startY = touch.clientY;
                        menuStartX = parseInt(contextMenu.style.left) || 0;
                        menuStartY = parseInt(contextMenu.style.top) || 0;
                        e.preventDefault();
                    }
                });

                document.addEventListener('touchmove', (e) => {
                    if (isDragging) {
                        const touch = e.touches[0];
                        const dx = touch.clientX - startX;
                        const dy = touch.clientY - startY;
                        const newLeft = menuStartX + dx;
                        const newTop = menuStartY + dy;

                        // 确保菜单不超出屏幕
                        const screenWidth = window.innerWidth;
                        const screenHeight = window.innerHeight;
                        const menuWidth = contextMenu.offsetWidth || 180;
                        const menuHeight = contextMenu.offsetHeight || 300;

                        const boundedLeft = Math.max(0, Math.min(newLeft, screenWidth - menuWidth));
                        const boundedTop = Math.max(0, Math.min(newTop, screenHeight - menuHeight));

                        contextMenu.style.left = `${boundedLeft}px`;
                        contextMenu.style.top = `${boundedTop}px`;
                    }
                });

                document.addEventListener('touchend', () => {
                    isDragging = false;
                });

                // 点击其他地方关闭右键菜单
                document.addEventListener('click', (e) => {
                    // 确保点击不是在菜单本身上
                    if (!contextMenu.contains(e.target)) {
                        contextMenu.classList.add('closing');
                        setTimeout(() => {
                            contextMenu.style.display = 'none';
                            contextMenu.classList.remove('closing');
                        }, 200);
                    }
                });

                // 加载应用到右键菜单
                loadPresetAppsToContextMenu();

                // 添加分割线
                const divider = document.createElement('div');
                divider.className = 'context-menu-divider';
                contextMenu.appendChild(divider);

                // 添加系统功能菜单
                addSystemMenuItems();
            }

            // 初始化右键菜单
            initContextMenu();

            // 加载预设应用（仅保留容器，不再通过加号按钮触发）
            function loadPresetApps() {
                const presetAppsContainer = document.getElementById('preset-apps-container');
                if (!presetAppsContainer) return;

                // 预设应用列表
                const presetApps = [
                    { name: '代码编辑器', file: 'code-editor.html', icon: './serve/files/icon/code-editor.svg' },
                    { name: '思维导图', file: 'mind-map.html', icon: './serve/files/icon/mind-map.svg' },
                    { name: '神秘书店', file: 'mystery-bookstore-gal.html', icon: './serve/files/icon/bookstore.svg' },
                    { name: '粒子物理', file: 'particle-physics.html', icon: './serve/files/icon/physics.svg' },
                    { name: '像素艺术', file: 'pixel-art.html', icon: './serve/files/icon/pixel-art.svg' },
                    { name: '像素编辑器', file: 'pixel-editor.html', icon: './serve/files/icon/pixel-editor.svg' },
                    { name: '程序员贪吃蛇', file: 'programmer-snake.html', icon: './serve/files/icon/snake.svg' },
                    { name: '节奏游戏', file: 'rhythm-game.html', icon: './serve/files/icon/music.svg' },
                    { name: '旅行日志', file: 'travel-log.html', icon: './serve/files/icon/travel.svg' },
                    { name: '空白HTML', file: 'about:blank', icon: './serve/files/icon/html.svg' }
                ];

                // 清空容器
                presetAppsContainer.innerHTML = '';

                // 添加预设应用
                presetApps.forEach(app => {
                    const appButton = document.createElement('div');
                    appButton.className = 'preset-app-button';
                    appButton.style.width = '80px';
                    appButton.style.height = '80px';
                    appButton.style.display = 'flex';
                    appButton.style.flexDirection = 'column';
                    appButton.style.alignItems = 'center';
                    appButton.style.justifyContent = 'center';
                    appButton.style.backgroundColor = 'rgba(255, 255, 255, 0.2)';
                    appButton.style.borderRadius = '10px';
                    appButton.style.cursor = 'pointer';
                    appButton.style.transition = 'all 0.2s';
                    appButton.style.color = 'white';
                    appButton.style.fontSize = '12px';
                    appButton.style.padding = '5px';
                    appButton.style.boxSizing = 'border-box';

                    // 应用图标
                    const appIcon = document.createElement('img');
                    appIcon.src = app.icon;
                    appIcon.alt = app.name;
                    appIcon.style.width = '32px';
                    appIcon.style.height = '32px';
                    appIcon.style.marginBottom = '5px';

                    // 应用名称
                    const appName = document.createElement('div');
                    appName.textContent = app.name;
                    appName.style.textAlign = 'center';
                    appName.style.overflow = 'hidden';
                    appName.style.textOverflow = 'ellipsis';
                    appName.style.whiteSpace = 'nowrap';
                    appName.style.width = '100%';

                    // 组装
                    appButton.appendChild(appIcon);
                    appButton.appendChild(appName);

                    // 点击事件
                    appButton.addEventListener('click', () => {
                        if (app.file === 'about:blank') {
                            window.createCustomWindow({
                                title: app.name,
                                icon: app.icon,
                                url: app.file
                            });
                        } else {
                            window.createCustomWindow({
                                title: app.name,
                                icon: app.icon,
                                url: `./users/applications/${app.file}`
                            });
                        }
                    });

                    // 悬停效果
                    appButton.addEventListener('mouseenter', () => {
                        appButton.style.backgroundColor = 'rgba(255, 255, 255, 0.3)';
                        appButton.style.transform = 'scale(1.05)';
                    });

                    appButton.addEventListener('mouseleave', () => {
                        appButton.style.backgroundColor = 'rgba(255, 255, 255, 0.2)';
                        appButton.style.transform = 'scale(1)';
                    });

                    presetAppsContainer.appendChild(appButton);
                });
            }

            // 初始化时加载任务栏应用和预设应用
            // loadAppsToDock(); // 该函数未定义，已注释
            loadPresetApps();

            // 触发搜索框进入动画
            setTimeout(function () {
                const searchContainer = document.getElementById('search-container');
                if (searchContainer) {
                    searchContainer.classList.add('show');
                }
            }, 100); // 轻微延迟以确保动画流畅

            // 触发任务栏飞入动画
            setTimeout(function () {
                const dock = document.getElementById('dock');
                if (dock) {
                    dock.classList.add('visible');
                }
            }, 300); // 延迟300ms，在搜索框动画之后触发任务栏动画

        });
        

    </script>
</body>

</html>